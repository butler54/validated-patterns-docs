---
menu:
  learn:
    parent: Validated patterns frameworks
title: Creating a validated pattern using the AGOF framework
weight: 24
aliases: /ocp-framework/agof/
---

:toc:
:imagesdir: /images
:_content-type: ASSEMBLY
include::modules/comm-attributes.adoc[]

== Creating a validated pattern using the AGOF framework

Whichever method you use to deploy a validated pattern you need to:

. Clone the link:https://github.com/mhjacks/agof_demo_config[Ansible GitOps Framework Minimal Demo] repository. This is a minimal pattern that demonstrates how to use the Ansible GitOps Framework.
+
[source,terminal]
----
$ git clone https://github.com/validatedpatterns-demos/agof_minimal_demo.git
----

. Clone the link:https://github.com/validatedpatterns/agof[AGOF] repository. This serves as the provisioner for the pattern
+
[source,terminal]
----
$ git clone https://github.com/validatedpatterns-demos/agof_minimal_demo.git
----

=== Deploying using the AWS-based install method

This method: 

. Builds an AWS image using Red Hat's ImageBuilder.

. Deploys that image onto a new AWS VPC and subnet.

. Deploys AAP on that image using the command line installer. 

. Hands over the configuration of the AAP installation to the specified `controller_config_dir`. 

.Prerequisites

You need to provide some key information to a file named `agof_vault.yml` created in your home directory. The key pieces of information needed are: 

* The name of a hosted zone created under Route 53 in AWS. For example this could be `aws.validatedpatterns.io`.

* Your AWS account `Account ID`

* Your `aws key`

* Your `secret access key`

.Procedure

. Copy the `agof_vault_template.yml` from the cloned `agof` directory to your home directory and rename it `agof_vault.yml`. 
+
[source,terminal]
----
$ cp ~/agof/agof_vault_template.yml ~/agof_vault.yml
----
+
.agof_vault settings
[cols="30%,70%",options="header"]
|===
| Argument | Description

| `aws_account_nbr_vault`
a| Your AWS account number. This is needed for sharing composer images.

| `aws_access_key_vault`
a| Your AWS access key.

| `aws_secret_key_vault`
a| Your AWS secret key.

| `pattern_prefix`
a| A unique prefix to distinguish instances in AWS. Used as the pattern name and in public DNS entries.

| `ec2_region`
a| An AWS region that your account has access to.

| `offline_token`
a| A Red Hat offline token used to build the RHEL image on link:https://console.redhat.com[console.redhat.com].

[NOTE]
====
Click the `GENERATE TOKEN` link at link:https://access.redhat.com/management/api[Red Hat API Tokens] to create the token. 
====

| `redhat_username`
a| Red Hat Subscription username, used to log in to link:https://registry.redhat.io[registry.redhat.io].

| `redhat_password`
a| Red Hat Subscription password, used to log in to link:https://registry.redhat.io[registry.redhat.io].

| `admin_password`
a| An admin password for AAP Controller and Automation Hub.

| `manifest_content`
a| Content for a manifest file to entitle AAP Controller. See below for an example of how to point to a local file.

| `org_number_vault`
a| The Organization Number (Org ID) attached to your Red Hat Subscription for RHEL and AAP.

| `activation_key_vault`
a| The name of an Activation Key to embed in the imagebuilder image.

[NOTE]
====
Click the `Create Activation Keys` link at link:https://console.redhat.com[console.redhat.com] > *Red Hat Enterprise Linux* > *Inventory* > *System Configuration* > *Activation Keys* to create an activation key. 
====

| `skip_imagebuilder_build`
a| Set these variables to provide your own AMI, or to re-use an AMI previously generated with this process. When a previously built AMI is found this check does not take place. 
#imagebuilder_ami: 'The ID of an AWS AMI image, preferably one that was built with this toolkit'

| `automation_hub_token_vault`
a| A token associated with your AAP subscription used to retrieve Automation Hub content.

[NOTE]
====
Click the `Load token` link at link:https://console.redhat.com[console.redhat.com] > *Ansible Automation Platform* > *Automation Hub* > *Connect to Hub* to generate a token. 
====

| `automation_hub_url_certified_vault`
a| Optional: The private automation hub URL for certified content.

| `automation_hub_url_validated_vault`
a| Optional: The private automation hub URL for validated content.

|===


. Edit the file and add the following:

* `controller_config_dir:` set it's value to `{{ '~/agof_minimal_demo/config' | expanduser }}`.
* `db_password:` set an appropriate value for the postgres password for the DB instance for example `test`. 
* `agof_statedir:` set its value to "{{ '~/agof' | expanduser }}"
* `agof_iac_repo:` set its value to "https://github.com/mhjacks/agof_demo_config.git"

. Optional: Create a subscription manifest by following the guidance at link:https://docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/2.4/htmlred_hat_ansible_automation_platform_operations_guide/assembly-aap-obtain-manifest-files#assembly-aap-obtain-manifest-files[Obtaining a manifest file]

.. Update your `agof_vault.yml` file with the path to downloaded manifest zip file. For example add the following: 
+
[source,shell]
----
controller_license_src_file: '~/Downloads/manifest_<sub_allocation_name>_20240924T131518Z.zip'
manifest_content: "{{ lookup('file', controller_license_src_file) | b64encode }}"
----

.Example agof_vault.yml file

[source,yaml]
----
---
aws_account_nbr_vault: '293265215425'
aws_access_key_vault: 'AKIAIJ6ZIKPAUZGF2643'
aws_secret_key_vault: 'gMC3Jy3/MZtOosjUDHy0Nl/2mp2HQok1JDfCQGKUR'

pattern_prefix: 'foga'
pattern_dns_zone: 'aws.validatedpatterns.io'

ec2_name_prefix: 'foga-testing'
ec2_region: 'us-east-1'

offline_token: 'eyJhbGciOiJIUzUxMiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI0NzQzYTkzMC03YmJiLTRkZGQtOTgzMS00ODcxNGRlZDc0YjUifQ.eyJpYXQiOjE3MjY4MjcxNDcsImp0aSI6ImJlNjdhZDQ4LWUzNWQtNDg1Yy04OTM2LTMwMzNmODgwM2Q0MSIsImlzcyI6Imh0dHBzOi8vc3NvLnJlZGhhdC5jb20vYXV0aC9yZWFsbXMvcmVkaGF0LWV4dGVybmFsIiwiYXVkIjoiaHR0cHM6Ly9zc28ucmVkaGF0LmNvbS9hdXRoL3JlYWxtcy9yZWRoYXQtZXh0ZXJuYWwiLCJzdWIiOiJmOjUyOGQ3NmZmLWY3MDgtNDNlZC04Y2Q1LWZlMTZmNGZlMGNlNjpyaG4tc3VwcG9ydC1rcXVpbm4iLCJ0eXAiOiJPZmZsaW5lIiwiYXpwIjoicmhzbS1hcGkiLCJzaWQiOiJhMGQ3YTEzYy1kNDM2LTQ1ZGEtOGZjZi1kOThlY2VjZDczNzkiLCJzY29wZSI6ImJhc2ljIHJvbGVzIHdlYi1vcmlnaW5zIGNsaWVudF90eXBlLnByZV9rYzI1IG9mZmxpbmVfYWNjZXNzIn0.482J5PUtr2TQCl-EUjmIwwCXe-o9_SYCuOABfpunxzGoTOdHevW7LQTGUrJ6FOrNPReuOdIwiA5KijowEVxeRw'

redhat_username: 'rhn-support-myusername'
redhat_password: 'passwd01'

admin_password: 'redhat123!'

manifest_content: "Content for a manifest file to entitle AAP Controller. See below for an example of how to point to a local file"
#manifest_content: "{{ lookup('file', '~/Downloads/manifest_AVP_20230510T202608Z.zip') | b64encode }}"

org_number_vault: "1778713"
activation_key_vault: "kevs-agof-key"

# Set these variables to provide your own AMI, or to re-use an AMI previously generated with this process
#skip_imagebuilder_build: 'boolean: skips imagebuilder build process'
#imagebuilder_ami: 'The ID of an AWS AMI image, preferably one that was built with this toolkit'

automation_hub_token_vault: 'eyJhbGciOiJIUzUxMiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI0NzQzYTkzMC03YmJiLTRkZGQtOTgzMS00ODcxNGRlZDc0YjUifQ.eyJpYXQiOjE3MjY4MjIxNzEsImp0aSI6IjQ2Y2ZjZmU2LTY0ZTgtNDgyYS04Mjc1LWFlZjEzNTY3NjUxMiIsImlzcyI6Imh0dHBzOi8vc3NvLnJlZGhhdC5jb20vYXV0aC9yZWFsbXMvcmVkaGF0LWV4dGVybmFsIiwiYXVkIjoiaHR0cHM6Ly9zc28ucmVkaGF0LmNvbS9hdXRoL3JlYWxtcy9yZWRoYXQtZXh0ZXJuYWwiLCJzdWIiOiJmOjUyOGQ3NmZmLWY3MDgtNDNlZC04Y2Q1LWZlMTZmNGZlMGNlNjpyaG4tc3VwcG9ydC1rcXVpbm4iLCJ0eXAiOiJPZmZsaW5lIiwiYXpwIjoiY2xvdWQtc2VydmljZXMiLCJub25jZSI6IjI1NzQ3MDg1LTc2ZTEtNGIzZS05Y2U2LTE0MjJiNDY1ODAwMiIsInNpZCI6ImEwZDdhMTNjLWQ0MzYtNDVkYS04ZmNmLWQ5OGVjZWNkNzM3OSIsInNjb3BlIjoib3BlbmlkIGJhc2ljIGFwaS5pYW0uc2VydmljZV9hY2NvdW50cyByb2xlcyB3ZWItb3JpZ2lucyBjbGllbnRfdHlwZS5wcmVfa2MyNSBvZmZsaW5lX2FjY2VzcyJ9.pL3Ls9m0-AJqlRWdGnv7HEyIxA-PcQNR0RCtc8vqeMHaTgSME1h6Xd5rysyVzChRAHsPNv_kGwsgfx0DlnQ9jA'

# These variables can be set but are optional. The previous (before AAP 2.4) conncept of sync-list was private
# to an account.
#automation_hub_url_certified_vault: 'The private automation hub URL for certified content'
#automation_hub_url_validated_vault: 'The private automation hub URL for validated content'

controller_config_dir: "{{ '~/agof_minimal_demo/config' | expanduser }}"

db_password: 'test'

agof_statedir: "{{ '~/agof' | expanduser }}"
agof_iac_repo: "https://github.com/mhjacks/agof_demo_config.git"
----

. Run from the AGOF repository directory the following command : 
+
[source,terminal]
----
$ ./pattern.sh make install
----
This command invokes the `controller_configuration` `dispatch` role on the controller endpoint based on the configuration found in the `controller_configuration_dir` and in your `agof_vault.yml` file. This controls all of the controller configuration. Based on the variables defined in the controller configuration, `dispatch` calls the necessary roles and modules in the right order to configure AAP to run your pattern.

.Verification

The default installation provides an AAP 2.4 installation deployed using the containerized installer, with services deployed this way:

.agof_vault settings
[cols="30%,70%",options="header"]
|===
| URL | Service

| `https:{{ ec2_name_prefix }}.{{ domain }}:8443`
a| Controller API. 

| `https:{{ ec2_name_prefix }}.{{ domain }}:8444/` 
a|Private Automation Hub

| `https:/{{ ec2_name_prefix }}.{{ domain }}:8445/``
a| EDA Automation Controller

|===

Once the install completes, you will have a project, an inventory (consisting of the AAP controller), a credential (the private key from ec2), a job template (which runs a fact gather on the AAP controller) and a schedule that will run the job template every 5 minutes,

. Log in to `https:{{ ec2_name_prefix }}.{{ domain }}:8443` with the username `admin` and the password as configured in `admin_password` field of `agof_vault.yml`. 

. Under *Resources* > *Projects* verify the project *Ansible GitOps Framework Minimal Demo* is created with status *Successful*.

. Under *Resources* > *Inventories* verify the inventory *AGOF Demo Inventory* is created with sync status *Success*.

. Under *Resources* > *Templates* verify the job template *Ping Playbook* is created.

. Under *Resources* > *Credentials* verify the ec2 ssh credential *ec2_ssh_credential* is created.

. Under *Views* > *Schedules* verify the schedules are created.


=== Method 2: Pre-configured VMs Install

This method allows the installation of AAP on pre-configured Red Hat Enterprise Linux (RHEL) VMs. It requires you to provide an inventory file that specifies details about the VMs or instances where AAP will be installed. 

It is designed for users with existing infrastructure who want to deploy AAP without depending on AWS. If you need to install a pattern on a cluster with a different topology than this, use the API install mechanism.

[source,shell]
----
./pattern.sh make legacy_from_os_install INVENTORY=(your_inventory_file)
----

The path to `your_inventory_file` defaults to ~/inventory_agof if you do not specify one.

.Example agof_inventory file

[source,yaml]
----
[build_control]
localhost

[aap_controllers]
192.168.5.207

[automation_hub]

[eda_controllers]

[aap_controllers:vars]

[automation_hub:vars]

[all:vars]
ansible_user=myuser
ansible_ssh_pass=mypass
ansible_become_pass=mypass
ansible_remote_tmp=/tmp/.ansible
username=myuser
controller_hostname=192.168.5.207
----

=== Method 3: Custom Ansible controller (API install)

In this method, you provide an existing Ansible Automation Platform (AAP) Controller endpoint, either on bare metal or in a private cloud, without needing AWS or pre-configured VMs. 

Specify 

manifest
endpoint hostname
admin credentials, and pass the installation process to a predefined `controller_config_dir`. 


[source,terminal]
----
./pattern.sh make api_install
----

=== Tearing down the installation 

To tear down the installation run the following command:
+
[source,terminal]
----
$ ./pattern.sh make aws_uninstall
----
